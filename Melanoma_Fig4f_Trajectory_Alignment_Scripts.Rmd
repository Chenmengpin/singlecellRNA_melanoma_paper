
# Load libraries

```
library(reshape2)
library(cellAlign)
library(reshape2)
library(princurve)
library(ggplot2)
```

# Load data

## Meta Data

```{r}
load("/ddn1/vol1/staging/leuven/stg_00002/lcb/zkalender/scRNA_seq_melanoma/analysis_40k/20.analysis_with_sub_matrices/1.three_MM_lines_SOX/00.RData/meta_data.RData")
```

## MM057

```{r}
load("/ddn1/vol1/staging/leuven/stg_00002/lcb/zkalender/scRNA_seq_melanoma/analysis_40k/20.analysis_with_sub_matrices/3.MM057_SOX/00.RData/SCORPIUS_var_genes_workspace.RData", envir = MM057.SCORPIUS <- new.env())
load("/ddn1/vol1/staging/leuven/stg_00002/lcb/zkalender/scRNA_seq_melanoma/analysis_40k/20.analysis_with_sub_matrices/3.MM057_SOX/00.RData/MM057_monocle_obj.RData", envir = MM057.monocle <- new.env())
```

## MM074

```{r}
load("/ddn1/vol1/staging/leuven/stg_00002/lcb/zkalender/scRNA_seq_melanoma/analysis_40k/20.analysis_with_sub_matrices/5.MM074_SOX/00.RData/SCORPIUS_var_genes_workspace.RData", envir = MM074.SCORPIUS <- new.env())
load("/ddn1/vol1/staging/leuven/stg_00002/lcb/kspan/scRNA_seq_melanoma/analysis_40k/20.analysis_with_sub_matrices/5.MM074_SOX/00.RData/MM074_monocle_obj.RData", envir = MM074.monocle <- new.env())
```

## MM087

```{r}
load("/ddn1/vol1/staging/leuven/stg_00002/lcb/zkalender/scRNA_seq_melanoma/analysis_40k/20.analysis_with_sub_matrices/7.M0087_SOX/00.RData/SCORPIUS_var_genes_workspace.RData", envir = MM087.SCORPIUS <- new.env())
load("/ddn1/vol1/staging/leuven/stg_00002/lcb/zkalender/scRNA_seq_melanoma/analysis_40k/20.analysis_with_sub_matrices/7.M0087_SOX/00.RData/MM087_monocle_obj.RData", envir = MM087.monocle <- new.env())
```

# Utility functions

```{r}
aligner<-function(query.interpolator, ref.interpolator, sig.calc = F, num.perm = 200) {
  return (list("alignment"=globalAlign(x = query.interpolator$scaledData
                                       , y = ref.interpolator$scaledData
                                       , scores = list(query = query.interpolator$traj, 
                                                       ref = ref.interpolator$traj)
                                       , sigCalc = sig.calc, numPerm = num.perm)
               , "query.interpolator"=query.interpolator
               , "ref.interpolator"=ref.interpolator))
}
```

# Pre-process

## Diffusion Map pseudo-time

Extract DC components for each MM line, 

```{r}
three.MM.SOX.DC<-read.table(file = "/ddn1/vol1/staging/leuven/stg_00002/lcb/zkalender/scRNA_seq_melanoma/analysis_40k/20.analysis_with_sub_matrices/1.three_MM_lines_SOX/10.TextData/seurat_dc1_dc2.tsv", header = T, sep = "\t", quote = '', stringsAsFactors = F)
three.MM.SOX<-merge(x = meta_data, three.MM.SOX.DC, all = T, by = "row.names")
row.names(three.MM.SOX)<-three.MM.SOX$Row.names
MM057.SOX.DC<-three.MM.SOX[three.MM.SOX$Cell_Line=="MM057", c("DM1", "DM2")]
MM074.SOX.DC<-three.MM.SOX[three.MM.SOX$Cell_Line=="MM074", c("DM1", "DM2")]
MM087.SOX.DC<-three.MM.SOX[three.MM.SOX$Cell_Line=="MM087", c("DM1", "DM2")]
```

Fitting a lowess curve,

```{r}
MM057.SOX.DC.lowess = principal_curve(as.matrix(MM057.SOX.DC[, 1:2]), start = as.matrix(MM057.SOX.DC[, 1:2]), smoother = "lowess", plot_iterations = F, iter = 0, stretch = 2)
MM074.SOX.DC.lowess = principal_curve(as.matrix(MM074.SOX.DC[, 1:2]), start = as.matrix(MM074.SOX.DC[, 1:2]), smoother = "lowess", plot_iterations = F, iter = 0, stretch = 2)
MM087.SOX.DC.lowess = principal_curve(as.matrix(MM087.SOX.DC[, 1:2]), start = as.matrix(MM087.SOX.DC[, 1:2]), smoother = "lowess", plot_iterations = F, iter = 0, stretch = 2)
```

Plotting the fitted curves for MM057,
```{r}
# Fit and get the coorinates of the fitting line
MM057.SOX.DC.lowess<-three.MM.lines.DC.alignment$MM057$princurve.lowess
MM057.SOX.DC.lowess.fit<-MM057.SOX.DC.lowess$s[order(MM057.SOX.DC.lowess$lambda), ]
# Plot points and fitted line
library(ggplot2)
ggplot(data = as.data.frame(MM057.SOX.DC[, 1:2]), aes(x = DM1, y = DM2)) + 
  geom_point(color='blue') +
  geom_line(color='red',data = as.data.frame(MM057.SOX.DC.lowess.fit), aes(x=DM1, y=DM2))
```

Plotting the fitted curve for MM074,
```{r}
# Fit and get the coordinates of the fitting line
MM074.SOX.DC.lowess<-three.MM.lines.DC.alignment$MM074$princurve.lowess
MM074.SOX.DC.lowess.fit<-MM074.SOX.DC.lowess$s[order(MM074.SOX.DC.lowess$lambda), ]
# Plot points and fitted line
library(ggplot2)
ggplot(data = as.data.frame(MM074.SOX.DC[, 1:2]), aes(x = DM1, y = DM2)) + 
  geom_point(color='blue') +
  geom_line(color='red',data = as.data.frame(MM074.SOX.DC.lowess.fit), aes(x=DM1, y=DM2))
```

Plotting the fitted curve for MM87,
```{r}
# Fit and get the coorinates of the fitting line
MM087.SOX.DC.lowess<-three.MM.lines.DC.alignment$MM087$princurve.lowess
MM087.SOX.DC.lowess.fit<-MM087.SOX.DC.lowess$s[order(MM087.SOX.DC.lowess$lambda), ]
# Plot points and fitted line
library(ggplot2)
ggplot(data = as.data.frame(MM087.SOX.DC[, 1:2]), aes(x = DM1, y = DM2)) + 
  geom_point(color='blue') +
  geom_line(color='red',data = as.data.frame(MM087.SOX.DC.lowess.fit), aes(x=DM1, y=DM2))
```


## Pseudo-time scaling

```{r}
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
MM057.SOX.DC.pseudotime.scaled<-1-range01(x = MM057.SOX.DC.lowess$lambda)
MM074.SOX.DC.pseudotime.scaled<-range01(x = MM074.SOX.DC.lowess$lambda)
MM087.SOX.DC.pseudotime.scaled<-1-range01(x = MM087.SOX.DC.lowess$lambda)
```

## Interpolate

```{r}
numPts = 200
gep.inter.global.MM057.DC <- interWeights(
    expDataBatch = MM057.monocle$MM057_cds@assayData$exprs[, names(MM057.SOX.DC.pseudotime.scaled)],
    trajCond = MM057.SOX.DC.pseudotime.scaled, winSz = 0.1, numPts = numPts
)
gep.inter.global.MM074.DC <- interWeights(
    expDataBatch = MM074.monocle$MM074_cds@assayData$exprs[, names(MM074.SOX.DC.pseudotime.scaled)],
    trajCond = MM074.SOX.DC.pseudotime.scaled, winSz = 0.1, numPts = numPts
)
gep.inter.global.MM087.DC <- interWeights(
    expDataBatch = MM087.monocle$MM087_cds@assayData$exprs[, names(MM087.SOX.DC.pseudotime.scaled)],
    trajCond = MM087.SOX.DC.pseudotime.scaled, winSz = 0.1, numPts = numPts
)
```

## Scale

```{r}
gep.inter.scaled.global.MM057.DC = scaleInterpolate(gep.inter.global.MM057.DC)
gep.inter.scaled.global.MM074.DC = scaleInterpolate(gep.inter.global.MM074.DC)
gep.inter.scaled.global.MM087.DC = scaleInterpolate(gep.inter.global.MM087.DC)
```

## Store in environment

```
three.MM.lines.DC.alignment<-new.env()
three.MM.lines.DC.alignment$MM057<-list("DC"=MM057.SOX.DC
                                        , "princurve.lowess"=MM057.SOX.DC.lowess
                                        , "princurve.lowess.fit"=MM057.SOX.DC.lowess.fit
                                        , "princurve.pseudo.time.scaled"=MM057.SOX.DC.pseudotime.scaled
                                        , "cellAlign.inter.global"=gep.inter.global.MM057.DC
                                        , "cellAlign.inter.global.scaled"=gep.inter.scaled.global.MM057.DC)
three.MM.lines.DC.alignment$MM074<-list("DC"=MM074.SOX.DC
                                        , "princurve.lowess"=MM074.SOX.DC.lowess
                                        , "princurve.lowess.fit"=MM074.SOX.DC.lowess.fit
                                        , "princurve.pseudo.time.scaled"=MM074.SOX.DC.pseudotime.scaled
                                        , "cellAlign.inter.global"=gep.inter.global.MM074.DC
                                        , "cellAlign.inter.global.scaled"=gep.inter.scaled.global.MM074.DC)
three.MM.lines.DC.alignment$MM087<-list("DC"=MM087.SOX.DC
                                        , "princurve.lowess"=MM087.SOX.DC.lowess
                                        , "princurve.lowess.fit"=MM087.SOX.DC.lowess.fit
                                        , "princurve.pseudo.time.scaled"=MM087.SOX.DC.pseudotime.scaled
                                        , "cellAlign.inter.global"=gep.inter.global.MM087.DC
                                        , "cellAlign.inter.global.scaled"=gep.inter.scaled.global.MM087.DC)
```

# Align

## Align MM074 to MM057

```{r}
MM074.to.MM057.aligner<-aligner(
    query.interpolator = three.MM.lines.DC.alignment$MM074$cellAlign.inter.global.scaled,
    ref.interpolator = three.MM.lines.DC.alignment$MM057$cellAlign.inter.global.scaled
)
```

## Align MM087 to MM057,

```{r}
MM087.to.MM057.aligner<-aligner(
    query.interpolator = three.MM.lines.DC.alignment$MM087$cellAlign.inter.global.scaled,
    ref.interpolator = three.MM.lines.DC.alignment$MM057$cellAlign.inter.global.scaled
)
three.MM.lines.DC.alignment$MM087$cellAlign.alignedToMM057.alignment<-MM087.to.MM057.aligner$alignment
```

# Plot alignments

```{r}
plotAlign(three.MM.lines.DC.alignment$MM074$cellAlign.alignedToMM057.alignment)
plotAlign(three.MM.lines.DC.alignment$MM087$cellAlign.alignedToMM057.alignment)
```